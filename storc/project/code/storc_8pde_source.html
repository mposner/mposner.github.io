<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>StoRC: storc.pde Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">StoRC
   
   </div>
   <div id="projectbrief">Autonomous Payload Delivery System</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('storc_8pde.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">storc.pde</div>  </div>
</div>
<div class="contents">
<a href="storc_8pde.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***********************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> * StoRC - Search to Rescue Craft</span>
<a name="l00003"></a>00003 <span class="comment"> * MEAM Senior Design 2011-2012</span>
<a name="l00004"></a>00004 <span class="comment"> * </span>
<a name="l00005"></a>00005 <span class="comment"> * Authors:  Michael Posner (CIS, MEAM &#39;12)</span>
<a name="l00006"></a>00006 <span class="comment"> * Timothy Hennelly (ESE &#39;12)</span>
<a name="l00007"></a>00007 <span class="comment"> * Jacob Orloff (MEAM &#39;12)</span>
<a name="l00008"></a>00008 <span class="comment"> * </span>
<a name="l00009"></a>00009 <span class="comment"> * (some code from ArduPilot Mega project, found here:</span>
<a name="l00010"></a>00010 <span class="comment"> * http://code.google.com/p/ardupilot-mega/ )</span>
<a name="l00011"></a>00011 <span class="comment"> * </span>
<a name="l00012"></a>00012 <span class="comment"> * Licensing:</span>
<a name="l00013"></a>00013 <span class="comment"> * </span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software: you can redistribute it and/or modify </span>
<a name="l00015"></a>00015 <span class="comment"> * it under the terms of the GNU General Public License as published by </span>
<a name="l00016"></a>00016 <span class="comment"> * the Free Software Foundation, either version 3 of the License, or </span>
<a name="l00017"></a>00017 <span class="comment"> * (at your option) any later version. </span>
<a name="l00018"></a>00018 <span class="comment"> * </span>
<a name="l00019"></a>00019 <span class="comment"> * This program is distributed in the hope that it will be useful, </span>
<a name="l00020"></a>00020 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of </span>
<a name="l00021"></a>00021 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the </span>
<a name="l00022"></a>00022 <span class="comment"> * GNU General Public License for more details. </span>
<a name="l00023"></a>00023 <span class="comment"> * </span>
<a name="l00024"></a>00024 <span class="comment"> * You should have received a copy of the GNU General Public License </span>
<a name="l00025"></a>00025 <span class="comment"> * along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00026"></a>00026 <span class="comment"> * </span>
<a name="l00027"></a>00027 <span class="comment"> ***********************************************************/</span>
<a name="l00028"></a>00028 <span class="comment"></span>
<a name="l00029"></a>00029 <span class="comment">/**</span>
<a name="l00030"></a>00030 <span class="comment"> *  @file storc.pde</span>
<a name="l00031"></a>00031 <span class="comment"> *  @brief Main file, contains Arduino setup() and loop() functions</span>
<a name="l00032"></a>00032 <span class="comment"> *  @author Michael Posner (CIS, MEAM &#39;12)</span>
<a name="l00033"></a>00033 <span class="comment"> *  @author Timothy Hennelly (ESE &#39;12)</span>
<a name="l00034"></a>00034 <span class="comment"> *  @author Jacob Orloff (MEAM &#39;12)</span>
<a name="l00035"></a>00035 <span class="comment"> *  </span>
<a name="l00036"></a>00036 <span class="comment"> */</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">// Libraries  --------------------------------------------------------</span>
<a name="l00039"></a>00039 <span class="comment">// (they have to be included by this main storc.pde file, not storc.h)</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">//ArduPilot Mega headers</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;FastSerial.h&gt;</span>  <span class="comment">//ArduPilot Mega library for better serial communication (used by common and GPS library, MUST BE FIRST #include )</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;AP_Common.h&gt;</span>  <span class="comment">//ArduPilot Mega common library</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;DataFlash.h&gt;</span>  <span class="comment">//ArduPilot Mega flash memory library</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;APM_RC.h&gt;</span>  <span class="comment">//ArduPilot Mega library for reading RC inputs and generating PWM pulses on output channels</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;AP_GPS.h&gt;</span>  <span class="comment">//ArduPilot Mega library for reading GPS data from GPS</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;APM_BMP085.h&gt;</span>  <span class="comment">//ArduPilot Mega library for reading the barometer (abs. pressure + temp)</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;AP_ADC.h&gt;</span>  <span class="comment">//ArduPilot Mega library for using ADC</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;AP_IMU.h&gt;</span>  <span class="comment">//ArduPilot Mega general header for including all relevant IMU headers</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;AP_Compass.h&gt;</span> <span class="comment">//ArduPilot Mega magnetometer library</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;AP_DCM.h&gt;</span>  <span class="comment">//ArduPilot Mega dcm library</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">//AVR headers</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="comment">//Arduino headers</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;SPI.h&gt;</span>  <span class="comment">// Arduino SPI lib  (for flash memory communication)</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;Wire.h&gt;</span>  <span class="comment">//Arduino I2C library (used by barometer)</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">//Project Headers  --------------------------------------------------</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="storc_8h.html" title="Main header file, contains global variables, includes, macros, etc.">storc.h</a>&quot;</span>  <span class="comment">//Main storc header file</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="controls_8h.html" title="Controls header file, contains all controls variables, gains, constants, etc.">controls.h</a>&quot;</span>  <span class="comment">//Controls header file</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">//Functions  --------------------------------------------------------</span>
<a name="l00065"></a>00065 <span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">/**</span>
<a name="l00067"></a>00067 <span class="comment"> * Function that runs every so often, as determined by {@link SLOW_LOOP_CLOCK}</span>
<a name="l00068"></a>00068 <span class="comment"> * @see loop</span>
<a name="l00069"></a>00069 <span class="comment"> */</span>
<a name="l00070"></a><a class="code" href="storc_8pde.html#a4204d4ae4375267ad4d5f5218e2b082e">00070</a> <span class="keywordtype">void</span> <a class="code" href="storc_8pde.html#a4204d4ae4375267ad4d5f5218e2b082e">slow_loop</a>(<span class="keywordtype">void</span>) {
<a name="l00071"></a>00071 
<a name="l00072"></a>00072   <span class="comment">//GPS</span>
<a name="l00073"></a>00073   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a75efdde4445e3a8167a05191ccb788da" title="whether or not to use gps, based on reading the slide_switch at power-on">use_gps</a> == <span class="keyword">true</span>) {
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     gps-&gt;update();
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">//debug_gps();</span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a159ca84d25a5487d8e81e4438725df19" title="Easy way to turn logging on (1) and off (0)">LOG</a> &amp;&amp; (<a class="code" href="storc_8h.html#a93b44c9ef85d047faf95d68a82611677" title="state of the logging switch on analog 6 (see LOGGING_SWITCH)">logging_sw</a> &gt; 512)) {
<a name="l00080"></a>00080       <span class="keywordflow">if</span>(gps-&gt;new_data) { <span class="comment">//If the GPS has new data</span>
<a name="l00081"></a>00081         <span class="comment">//adjust the GPS time:  GPS Millisecond time of week -&gt; HH:MM:SS</span>
<a name="l00082"></a>00082         <span class="keywordtype">long</span> day = floor((gps-&gt;time/1000)/<a class="code" href="storc_8h.html#a3aaee30ddedb3f6675aac341a66e39e2" title="Number of seconds in a day.">SEC_PER_DAY</a>);
<a name="l00083"></a>00083         <span class="keywordtype">long</span> hour = floor(((gps-&gt;time/1000) - day*<a class="code" href="storc_8h.html#a3aaee30ddedb3f6675aac341a66e39e2" title="Number of seconds in a day.">SEC_PER_DAY</a>)/<a class="code" href="storc_8h.html#a2d540510d5860d7f190d13124956bc57" title="Number of seconds in an hour.">SEC_PER_HOUR</a>);
<a name="l00084"></a>00084         <span class="keywordtype">long</span> minute = floor(((gps-&gt;time/1000) - day*SEC_PER_DAY - hour*<a class="code" href="storc_8h.html#a2d540510d5860d7f190d13124956bc57" title="Number of seconds in an hour.">SEC_PER_HOUR</a>)/<a class="code" href="storc_8h.html#ac47b302f1b8d2a7a9c035c417247be76" title="Number of seconds in a minute.">SEC_PER_MIN</a>);
<a name="l00085"></a>00085         <span class="keywordtype">long</span> second = floor((gps-&gt;time/1000) - day*SEC_PER_DAY - hour*SEC_PER_HOUR - minute*<a class="code" href="storc_8h.html#ac47b302f1b8d2a7a9c035c417247be76" title="Number of seconds in a minute.">SEC_PER_MIN</a>);
<a name="l00086"></a>00086 
<a name="l00087"></a>00087         <span class="comment">//convert to EST</span>
<a name="l00088"></a>00088         hour -= 5;
<a name="l00089"></a>00089         <span class="keywordflow">if</span>(hour &lt; 0) {
<a name="l00090"></a>00090           hour += 24;
<a name="l00091"></a>00091         }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         <span class="comment">//log gps data in flash memory (these values are sometimes *10^7 or *100, but we fix that in the read function)</span>
<a name="l00094"></a>00094         <a class="code" href="log_8pde.html#a2046716b03b637a66d4f91d1acd2b5f9">Log_Write_GPS</a>(day,hour,minute,second,gps-&gt;latitude,gps-&gt;longitude,gps-&gt;altitude,gps-&gt;ground_speed,gps-&gt;ground_course);  
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         gps-&gt;new_data = 0; <span class="comment">// We have read the data</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098         <a class="code" href="controls_8h.html#abf23acd253756d045644d128f7b6ade6">new_ALT</a> = gps-&gt;altitude/100.0; <span class="comment">// New altitude reading</span>
<a name="l00099"></a>00099         <a class="code" href="controls_8h.html#a340e3d22b86ff11a3c2480ee8231ffb0">updated_ALT</a> = 1;               <span class="comment">// Updated altitude is true</span>
<a name="l00100"></a>00100       }
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   }
<a name="l00106"></a>00106 
<a name="l00107"></a>00107   <span class="comment">//Barometer</span>
<a name="l00108"></a>00108   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a32486781d8c078736e577cf2ab76313f" title="declare an instance of the Barometer class">barometer</a>.Read() == 1) { <span class="comment">//if the barometer has new data</span>
<a name="l00109"></a>00109     <span class="comment">//debug_barometer();</span>
<a name="l00110"></a>00110     <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a159ca84d25a5487d8e81e4438725df19" title="Easy way to turn logging on (1) and off (0)">LOG</a> &amp;&amp; (<a class="code" href="storc_8h.html#a93b44c9ef85d047faf95d68a82611677" title="state of the logging switch on analog 6 (see LOGGING_SWITCH)">logging_sw</a> &gt; 512)) {
<a name="l00111"></a>00111       <a class="code" href="log_8pde.html#afbeb40204253063585e569a1b8e249d1">Log_Write_Barometer</a>((<span class="keywordtype">float</span>)(<a class="code" href="storc_8h.html#a32486781d8c078736e577cf2ab76313f" title="declare an instance of the Barometer class">barometer</a>.Temp)*0.1 + 273.15, (<span class="keywordtype">float</span>)(<a class="code" href="storc_8h.html#a32486781d8c078736e577cf2ab76313f" title="declare an instance of the Barometer class">barometer</a>.Press)/1000.0);  <span class="comment">//convert temp to K, press to kPa</span>
<a name="l00112"></a>00112     }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114   }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116   <span class="comment">//Log state</span>
<a name="l00117"></a>00117   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a159ca84d25a5487d8e81e4438725df19" title="Easy way to turn logging on (1) and off (0)">LOG</a>) {
<a name="l00118"></a>00118     <a class="code" href="log_8pde.html#a874c7b4735343dcf9802b0ab49f2afb7">Log_Write_State</a>(<a class="code" href="storc_8h.html#a10b9231b0f5575e2467df3c42d117aba" title="state of the drop servo">drop_state</a>, <a class="code" href="storc_8h.html#a93b44c9ef85d047faf95d68a82611677" title="state of the logging switch on analog 6 (see LOGGING_SWITCH)">logging_sw</a>, <a class="code" href="storc_8h.html#a07abf3b6e2a9bfc8a580db54c8c87a6c">get_wind_profile</a>, <a class="code" href="storc_8h.html#acd3802483bc195abc5c48c74e9223761" title="average wind in NS direction during ascent">avg_wind_ns</a>, <a class="code" href="storc_8h.html#a89a6ec07d2560ab4a87a1ce7ef3f164b" title="average wind in EW direction during ascent">avg_wind_ew</a>, <a class="code" href="storc_8h.html#af379d19d538c85605a7dddf0ecfd1252">drift_ns</a>, <a class="code" href="storc_8h.html#abdf5a4cccb85e47d067cd4296182fa8f">drift_ew</a>);
<a name="l00119"></a>00119   }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121   <span class="comment">//Controls ----------------------------------------------------------</span>
<a name="l00122"></a>00122   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#aae4f7019dabbfa7398307d486240d88d" title="Easy way to turn controls on (1) and off (0) - if off, Payload release is ON.">CONTROLS</a>){
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <span class="keywordflow">if</span> (<a class="code" href="storc_8h.html#a7fe1031f60be2285c7853174a53d86e6" title="RC switch for turning controls on/off.">rc_5</a> &gt; 1500){
<a name="l00125"></a>00125 
<a name="l00126"></a>00126       <span class="comment">//Navigation update</span>
<a name="l00127"></a>00127       <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a45bffb8cf8e480743632217c97522fe1" title="Turn outer loop navigation on (1) and off (0)">NAVIGATION</a>){
<a name="l00128"></a>00128 
<a name="l00129"></a>00129         <span class="comment">/*</span>
<a name="l00130"></a>00130 <span class="comment">        // Figure out where to go</span>
<a name="l00131"></a>00131 <span class="comment">         if(drop_state == false){ // If still have not delivered payload, go to target</span>
<a name="l00132"></a>00132 <span class="comment">         LAT_C = target_LAT;</span>
<a name="l00133"></a>00133 <span class="comment">         LON_C = target_LON;</span>
<a name="l00134"></a>00134 <span class="comment">         }else{ // If already delivered, go to start</span>
<a name="l00135"></a>00135 <span class="comment">         LAT_C = gps_start_lat;b</span>
<a name="l00136"></a>00136 <span class="comment">         LON_C = gps_start_lon;</span>
<a name="l00137"></a>00137 <span class="comment">         }</span>
<a name="l00138"></a>00138 <span class="comment">         */</span>
<a name="l00139"></a>00139          
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         <span class="comment">// Check if within Tolerance Radius Squared of the drop site</span>
<a name="l00142"></a>00142         <span class="comment">//dist2drop = (del_LAT*del_LAT)+(del_LON*del_LON);</span>
<a name="l00143"></a>00143         <span class="comment">//if(dist2drop &lt; TRS){</span>
<a name="l00144"></a>00144         <span class="keywordflow">if</span>((abs(<a class="code" href="controls_8h.html#a021cca49a75d6acf4e9110363821a2a6">del_LAT</a>) &lt; <a class="code" href="controls_8h.html#a2c12c38be1a5a50dfacf37fd866a1267">DROP_THRESH</a>) &amp;&amp; (abs(<a class="code" href="controls_8h.html#a8c9ddc10570ad19a610591732b532c3a">del_LON</a>) &lt; <a class="code" href="controls_8h.html#a2c12c38be1a5a50dfacf37fd866a1267">DROP_THRESH</a>)) {
<a name="l00145"></a>00145           <a class="code" href="rc_8pde.html#a7249f1f0e38621ffae257b910517516e">drop_payload</a>();
<a name="l00146"></a>00146           <a class="code" href="storc_8h.html#a10b9231b0f5575e2467df3c42d117aba" title="state of the drop servo">drop_state</a> = <span class="keyword">true</span>;
<a name="l00147"></a>00147           <a class="code" href="controls_8h.html#acb97c108f80b20cd17488a1bd9e2f73a">LAT_C</a> = <a class="code" href="storc_8h.html#a5aa0a8aaed7d1464ffc8174e99c4b151">gps_start_lat</a>;
<a name="l00148"></a>00148           <a class="code" href="controls_8h.html#a0459100820d9e59c08e793a09d5e4623">LON_C</a> = <a class="code" href="storc_8h.html#a0c76265d161a9b98826fda3e18f51ee3">gps_start_lon</a>;
<a name="l00149"></a>00149           Serial.println(<span class="stringliteral">&quot;----IN THE SACK----&quot;</span>);
<a name="l00150"></a>00150         }
<a name="l00151"></a>00151         <span class="keywordflow">else</span>{
<a name="l00152"></a>00152           <a class="code" href="rc_8pde.html#aa5875b9da340a42d8e95b4ecf3e042cd">reset_drop</a>();
<a name="l00153"></a>00153           Serial.println(<span class="stringliteral">&quot;----OUTTA THE SACK----&quot;</span>);
<a name="l00154"></a>00154         }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         <span class="comment">//calculate desired heading to align with destination</span>
<a name="l00157"></a>00157         <a class="code" href="controls_8h.html#a021cca49a75d6acf4e9110363821a2a6">del_LAT</a> = <a class="code" href="controls_8h.html#acb97c108f80b20cd17488a1bd9e2f73a">LAT_C</a> - (gps-&gt;latitude);
<a name="l00158"></a>00158         <a class="code" href="controls_8h.html#a8c9ddc10570ad19a610591732b532c3a">del_LON</a> = <a class="code" href="controls_8h.html#a0459100820d9e59c08e793a09d5e4623">LON_C</a> - (gps-&gt;longitude);
<a name="l00159"></a>00159         <a class="code" href="controls_8h.html#ad30ec13d858a14ae3d34dc84ada6b730">psi_c</a> = atan2(<a class="code" href="controls_8h.html#a021cca49a75d6acf4e9110363821a2a6">del_LAT</a>,del_LON);
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         <span class="comment">//convert psi_c to same reference frame as GPS Heading is in (atan2 returns in the range [-pi,pi])</span>
<a name="l00162"></a>00162         <span class="keywordflow">if</span>(psi_c &lt; 0) {
<a name="l00163"></a>00163           psi_c += 2.0*PI;
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166         psi_c = 2.0*PI-(psi_c-PI/2.0);
<a name="l00167"></a>00167 
<a name="l00168"></a>00168         psi_c = <a class="code" href="storc_8h.html#af93ab8e29004f71549e1cd50278c5473" title="Macro to convert radians to degrees.">RAD2DEG</a>(psi_c); <span class="comment">//convert to degrees</span>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <span class="comment">//calculate difference in desired from current heading</span>
<a name="l00171"></a>00171         <a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a> = psi_c - gps-&gt;ground_course/100.0;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="comment">//wrap if error is over 180 or less than -180</span>
<a name="l00174"></a>00174         <span class="keywordflow">if</span>(<a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a> &gt; 180) {
<a name="l00175"></a>00175           <a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a> -= 360;
<a name="l00176"></a>00176         }
<a name="l00177"></a>00177         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a> &lt; -180) {
<a name="l00178"></a>00178           <a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a> += 360;
<a name="l00179"></a>00179         }      
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <span class="comment">//calculate bank command based on difference</span>
<a name="l00182"></a>00182         <span class="keywordflow">if</span>( psi_error &lt; 0 &amp;&amp; psi_error &gt; -180 ) { <span class="comment">//psi_c is to the left of the plane, turn left</span>
<a name="l00183"></a>00183 
<a name="l00184"></a>00184           <a class="code" href="controls_8h.html#a552bd6e8a5e665a817f2e604867315e3">phi_c</a> = -<a class="code" href="controls_8h.html#a9833a691061279ed093551e3dee607f0" title="45deg of bank / 180deg of error">KP_PSI2PHI</a>*abs(<a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a>);
<a name="l00185"></a>00185         }
<a name="l00186"></a>00186         <span class="keywordflow">else</span> {  <span class="comment">//psi_c is to the right of the plane, turn right</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188           <a class="code" href="controls_8h.html#a552bd6e8a5e665a817f2e604867315e3">phi_c</a> = <a class="code" href="controls_8h.html#a9833a691061279ed093551e3dee607f0" title="45deg of bank / 180deg of error">KP_PSI2PHI</a>*abs(<a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a>);
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191         <a class="code" href="controls_8h.html#a552bd6e8a5e665a817f2e604867315e3">phi_c</a> = constrain(<a class="code" href="controls_8h.html#a552bd6e8a5e665a817f2e604867315e3">phi_c</a>,-45,45);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         <span class="comment">/*</span>
<a name="l00194"></a>00194 <span class="comment">        Serial.print(&quot;H: &quot;); </span>
<a name="l00195"></a>00195 <span class="comment">        Serial.print(gps-&gt;ground_course/100.0);</span>
<a name="l00196"></a>00196 <span class="comment">        Serial.print(&quot;, Psi_c: &quot;);  </span>
<a name="l00197"></a>00197 <span class="comment">        Serial.print(psi_c);</span>
<a name="l00198"></a>00198 <span class="comment">        Serial.print(&quot;, Phi_c: &quot;); </span>
<a name="l00199"></a>00199 <span class="comment">        Serial.print(phi_c);</span>
<a name="l00200"></a>00200 <span class="comment">        Serial.print(&quot;, d: &quot;);</span>
<a name="l00201"></a>00201 <span class="comment">        if(drop_state) {</span>
<a name="l00202"></a>00202 <span class="comment">          Serial.print(&quot;1&quot;);</span>
<a name="l00203"></a>00203 <span class="comment">        }</span>
<a name="l00204"></a>00204 <span class="comment">        else {</span>
<a name="l00205"></a>00205 <span class="comment">          Serial.print(&quot;0&quot;);</span>
<a name="l00206"></a>00206 <span class="comment">        }</span>
<a name="l00207"></a>00207 <span class="comment">        </span>
<a name="l00208"></a>00208 <span class="comment">        Serial.print(&quot;, LAT_C: &quot;);</span>
<a name="l00209"></a>00209 <span class="comment">        Serial.print(LAT_C);</span>
<a name="l00210"></a>00210 <span class="comment">        Serial.print(&quot;, LON_C: &quot;);</span>
<a name="l00211"></a>00211 <span class="comment">        Serial.print(LON_C);</span>
<a name="l00212"></a>00212 <span class="comment">        Serial.print(&quot;, real lat: &quot;);</span>
<a name="l00213"></a>00213 <span class="comment">        Serial.print(gps-&gt;latitude);</span>
<a name="l00214"></a>00214 <span class="comment">        Serial.print(&quot;, real lon: &quot;);</span>
<a name="l00215"></a>00215 <span class="comment">        Serial.print(gps-&gt;longitude);</span>
<a name="l00216"></a>00216 <span class="comment">        Serial.print(&quot;, DROP_THRESH: &quot;);</span>
<a name="l00217"></a>00217 <span class="comment">        Serial.print(DROP_THRESH);</span>
<a name="l00218"></a>00218 <span class="comment">        Serial.print(&quot;, del_LAT: &quot;);</span>
<a name="l00219"></a>00219 <span class="comment">        Serial.print(del_LAT);</span>
<a name="l00220"></a>00220 <span class="comment">        Serial.print(&quot;, del_LON: &quot;);</span>
<a name="l00221"></a>00221 <span class="comment">        Serial.println(del_LON);</span>
<a name="l00222"></a>00222 <span class="comment">        */</span>
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a159ca84d25a5487d8e81e4438725df19" title="Easy way to turn logging on (1) and off (0)">LOG</a> &amp;&amp; (<a class="code" href="storc_8h.html#a93b44c9ef85d047faf95d68a82611677" title="state of the logging switch on analog 6 (see LOGGING_SWITCH)">logging_sw</a> &gt; 512)) {
<a name="l00225"></a>00225           <a class="code" href="log_8pde.html#ad1b64ba0a4555ad47e07cac05067777e">Log_Write_Navigation</a>(<a class="code" href="controls_8h.html#acb97c108f80b20cd17488a1bd9e2f73a">LAT_C</a>, <a class="code" href="controls_8h.html#a0459100820d9e59c08e793a09d5e4623">LON_C</a>, <a class="code" href="controls_8h.html#a021cca49a75d6acf4e9110363821a2a6">del_LAT</a>, del_LON, psi_c, <a class="code" href="controls_8h.html#a191e70c9654ae669b8981acd7ca6488a">psi_error</a>, <a class="code" href="controls_8h.html#a552bd6e8a5e665a817f2e604867315e3">phi_c</a>, <a class="code" href="controls_8h.html#a2c12c38be1a5a50dfacf37fd866a1267">DROP_THRESH</a>);
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227       }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keywordflow">if</span> ((<a class="code" href="storc_8h.html#ae52df017b138fde620474b3aac767231" title="RC Payload Drop Input &amp; ELE_control on/off.">rc_4</a> &gt; 1500) &amp;&amp; (<a class="code" href="controls_8h.html#a340e3d22b86ff11a3c2480ee8231ffb0">updated_ALT</a>)){  <span class="comment">// Throttle Control</span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233       <span class="comment">// If just switched on </span>
<a name="l00234"></a>00234       <span class="keywordflow">if</span>(<a class="code" href="controls_8h.html#a19dbcf8cc06255000d8a9c92c7598d46">sw1</a> == 0){
<a name="l00235"></a>00235         <a class="code" href="controls_8h.html#a49d01e7954a41df3957c93453088a421">I_THR</a> = 0;                  <span class="comment">// Reset integrator to zero </span>
<a name="l00236"></a>00236         <a class="code" href="controls_8h.html#a265d52eb5fb1816176e4d3124e1b01b7">rc_thr_trim</a> = <a class="code" href="storc_8h.html#a3d6851b64714dca0406b6acb9a9e0867" title="RC Throttle Input.">rc_throttle</a>;  <span class="comment">// Remember throttle starting position</span>
<a name="l00237"></a>00237       }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239       <a class="code" href="controls_8h.html#a19dbcf8cc06255000d8a9c92c7598d46">sw1</a> = 1;                                      <span class="comment">// Set switch variable to high</span>
<a name="l00240"></a>00240 
<a name="l00241"></a>00241       <a class="code" href="controls_8h.html#af10a86d23fa988e8b53309318e8f1234">del_THR</a>= 0;                                  <span class="comment">// Reset to zero</span>
<a name="l00242"></a>00242       <a class="code" href="controls_8pde.html#afc0bc57d2c2e64f256967fec78427bf2">THR_control</a>(1.0/(<span class="keywordtype">float</span>)(<a class="code" href="storc_8h.html#a9683a7d8139095901da8a77ad48938bf" title="Slow loop clock speed in Hz.">SLOW_LOOP_CLOCK</a>));   <span class="comment">// Run the throttle controls algorithm. Use slow_loop timer since that&#39;s the sampling rate.</span>
<a name="l00243"></a>00243       <a class="code" href="controls_8h.html#a340e3d22b86ff11a3c2480ee8231ffb0">updated_ALT</a> = 0;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246     <span class="keywordflow">else</span>{
<a name="l00247"></a>00247       <a class="code" href="controls_8h.html#a19dbcf8cc06255000d8a9c92c7598d46">sw1</a> = 0;     <span class="comment">// Keep switch variable low</span>
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250   }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 <span class="comment"></span>
<a name="l00254"></a>00254 <span class="comment">/**</span>
<a name="l00255"></a>00255 <span class="comment"> * Function that runs every so often, as determined by {@link MED_LOOP_CLOCK}</span>
<a name="l00256"></a>00256 <span class="comment"> * @see loop</span>
<a name="l00257"></a>00257 <span class="comment"> */</span>
<a name="l00258"></a><a class="code" href="storc_8pde.html#a42b0ee59afb14d568f6ae6aae8121331">00258</a> <span class="keywordtype">void</span> <a class="code" href="storc_8pde.html#a42b0ee59afb14d568f6ae6aae8121331">medium_loop</a>(<span class="keywordtype">void</span>) {
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   <span class="comment">//Read logging switch</span>
<a name="l00261"></a>00261   <a class="code" href="storc_8h.html#a93b44c9ef85d047faf95d68a82611677" title="state of the logging switch on analog 6 (see LOGGING_SWITCH)">logging_sw</a> = analogRead(<a class="code" href="storc_8h.html#a5e245113a26446fd44c4d40db1038397" title="switch attached to analog 6 to control whether or not to log">LOGGING_SWITCH</a>);  <span class="comment">//analogRead returns 0-1023</span>
<a name="l00262"></a>00262 
<a name="l00263"></a>00263   <span class="comment">//test slide switch</span>
<a name="l00264"></a>00264   <span class="comment">//slide_sw = digitalRead(SLIDE_SWITCH);</span>
<a name="l00265"></a>00265   <span class="comment">//Serial.print(&quot;slide sw: &quot;);  Serial.println(slide_sw);</span>
<a name="l00266"></a>00266 
<a name="l00267"></a>00267   <span class="comment">//IMU ---------------------------------------------------------------</span>
<a name="l00268"></a>00268   <a class="code" href="storc_8h.html#a98361fed9fa0cbb710e8ede8fb1b9298" title="declare an instance of the DCM class">imu</a>.update();
<a name="l00269"></a>00269   <a class="code" href="storc_8h.html#aac5141d38d1cbc17d4dd0610a1426354">accel</a> = <a class="code" href="storc_8h.html#a98361fed9fa0cbb710e8ede8fb1b9298" title="declare an instance of the DCM class">imu</a>.get_accel();
<a name="l00270"></a>00270   <a class="code" href="storc_8h.html#a0d1811f25a78ba85a95c6514830b1fff">gyro</a> = <a class="code" href="storc_8h.html#a98361fed9fa0cbb710e8ede8fb1b9298" title="declare an instance of the DCM class">imu</a>.get_gyro();
<a name="l00271"></a>00271 
<a name="l00272"></a>00272   <span class="comment">//DCM ---------------------------------------------------------------</span>
<a name="l00273"></a>00273   <span class="comment">//debug_dcm();</span>
<a name="l00274"></a>00274 
<a name="l00275"></a>00275   <span class="comment">//Magnetometer ------------------------------------------------------</span>
<a name="l00276"></a>00276   <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.read();
<a name="l00277"></a>00277   <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.calculate(dcm.get_dcm_matrix());  <span class="comment">//use the current dcm matrix to adjust calculations</span>
<a name="l00278"></a>00278   <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.null_offsets(dcm.get_dcm_matrix());  <span class="comment">//re-evaluate offsets</span>
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   <span class="comment">//debug_magnetometer();</span>
<a name="l00281"></a>00281 
<a name="l00282"></a>00282   <span class="comment">//Airspeed ----------------------------------------------------------</span>
<a name="l00283"></a>00283   <a class="code" href="pitot_8pde.html#a5677978ede85b28f3b485e75f1dedf9f">update_airspeed</a>();
<a name="l00284"></a>00284   <span class="comment">//debug_airspeed();</span>
<a name="l00285"></a>00285 
<a name="l00286"></a>00286   <span class="keywordflow">if</span>(gps-&gt;altitude/100.0 &gt; 38+20) {  <span class="comment">//if we get high enough, profile over</span>
<a name="l00287"></a>00287     <a class="code" href="storc_8h.html#a07abf3b6e2a9bfc8a580db54c8c87a6c">get_wind_profile</a> = <span class="keyword">false</span>;
<a name="l00288"></a>00288   }
<a name="l00289"></a>00289   
<a name="l00290"></a>00290   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a07abf3b6e2a9bfc8a580db54c8c87a6c">get_wind_profile</a>) {
<a name="l00291"></a>00291     <span class="comment">//update average wind stuff while we&#39;re ascending</span>
<a name="l00292"></a>00292     <span class="comment">//get current wind speed, split into directions</span>
<a name="l00293"></a>00293     <span class="keywordtype">float</span> curr_wind_ns = (gps-&gt;ground_speed/100.0 - <a class="code" href="storc_8h.html#a2a48553c0ca332797b83fc7147f15679" title="stores current airspeed reading">airspeed</a>)*sin(<a class="code" href="storc_8h.html#a2b4f9c3a8b58ecc8e9a6cda26417ba00" title="Macro to convert degrees to radians.">DEG2RAD</a>(gps-&gt;ground_course/100.0));
<a name="l00294"></a>00294     <span class="keywordtype">float</span> curr_wind_ew = (gps-&gt;ground_speed/100.0 - <a class="code" href="storc_8h.html#a2a48553c0ca332797b83fc7147f15679" title="stores current airspeed reading">airspeed</a>)*cos(<a class="code" href="storc_8h.html#a2b4f9c3a8b58ecc8e9a6cda26417ba00" title="Macro to convert degrees to radians.">DEG2RAD</a>(gps-&gt;ground_course/100.0));
<a name="l00295"></a>00295   
<a name="l00296"></a>00296     <span class="comment">//add to running sum</span>
<a name="l00297"></a>00297     <a class="code" href="storc_8h.html#a581e898e7395c21ea29bc3a2b1fb06d5" title="running sum of wind samples in North South direction during ascent">sum_wind_ns</a> += curr_wind_ns;
<a name="l00298"></a>00298     <a class="code" href="storc_8h.html#a56dabaa2ae630bd9650d023c8e0adb72" title="running sum of wind samples in East West direction during ascent">sum_wind_ew</a> += curr_wind_ew;
<a name="l00299"></a>00299   
<a name="l00300"></a>00300     <span class="comment">//increment total number of samples</span>
<a name="l00301"></a>00301     <a class="code" href="storc_8h.html#a68f2e96f5336e95d674fe0cdacb3e253" title="total number of wind samples in NS direction during ascent">total_ns</a>++;
<a name="l00302"></a>00302     <a class="code" href="storc_8h.html#a982b05376b9d6cbd8c59972e78902513" title="total number of wind samples in EW direction during ascent">total_ew</a>++;
<a name="l00303"></a>00303   
<a name="l00304"></a>00304     <span class="comment">//calculate new average</span>
<a name="l00305"></a>00305     <a class="code" href="storc_8h.html#acd3802483bc195abc5c48c74e9223761" title="average wind in NS direction during ascent">avg_wind_ns</a> = <a class="code" href="storc_8h.html#a581e898e7395c21ea29bc3a2b1fb06d5" title="running sum of wind samples in North South direction during ascent">sum_wind_ns</a>/(float)(<a class="code" href="storc_8h.html#a68f2e96f5336e95d674fe0cdacb3e253" title="total number of wind samples in NS direction during ascent">total_ns</a>);
<a name="l00306"></a>00306     <a class="code" href="storc_8h.html#a89a6ec07d2560ab4a87a1ce7ef3f164b" title="average wind in EW direction during ascent">avg_wind_ew</a> = <a class="code" href="storc_8h.html#a56dabaa2ae630bd9650d023c8e0adb72" title="running sum of wind samples in East West direction during ascent">sum_wind_ew</a>/(float)(<a class="code" href="storc_8h.html#a982b05376b9d6cbd8c59972e78902513" title="total number of wind samples in EW direction during ascent">total_ew</a>);
<a name="l00307"></a>00307   }
<a name="l00308"></a>00308   <span class="keywordflow">else</span> {  <span class="comment">//do offset calculations</span>
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     <span class="keywordtype">int</span> s_ns = 1;  <span class="comment">//sign of ns wind</span>
<a name="l00311"></a>00311     <span class="keywordtype">int</span> s_ew = -1;  <span class="comment">//sign of ew wind</span>
<a name="l00312"></a>00312     
<a name="l00313"></a>00313     <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#acd3802483bc195abc5c48c74e9223761" title="average wind in NS direction during ascent">avg_wind_ns</a> &lt; 0) {
<a name="l00314"></a>00314       s_ns = -1;
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316     <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a89a6ec07d2560ab4a87a1ce7ef3f164b" title="average wind in EW direction during ascent">avg_wind_ew</a> &lt; 0) {
<a name="l00317"></a>00317       s_ew = -1;
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319     
<a name="l00320"></a>00320     <a class="code" href="storc_8h.html#af379d19d538c85605a7dddf0ecfd1252">drift_ns</a> = <a class="code" href="storc_8h.html#a66ad2cd1f70525e736b90f4b2c421eac">K_DRIFT</a>*(gps-&gt;altitude/100.0)*<a class="code" href="storc_8h.html#acd3802483bc195abc5c48c74e9223761" title="average wind in NS direction during ascent">avg_wind_ns</a>+(s_ns*<a class="code" href="storc_8h.html#a3ff49c2bbf9ae48bbcb71c82be67facc">OFFSET_DRIFT</a>);  <span class="comment">//drift [m] positive means will drift north  </span>
<a name="l00321"></a>00321     <a class="code" href="storc_8h.html#abdf5a4cccb85e47d067cd4296182fa8f">drift_ew</a> = <a class="code" href="storc_8h.html#a66ad2cd1f70525e736b90f4b2c421eac">K_DRIFT</a>*(gps-&gt;altitude/100.0)*<a class="code" href="storc_8h.html#a89a6ec07d2560ab4a87a1ce7ef3f164b" title="average wind in EW direction during ascent">avg_wind_ew</a>+(s_ew*<a class="code" href="storc_8h.html#a3ff49c2bbf9ae48bbcb71c82be67facc">OFFSET_DRIFT</a>);  <span class="comment">//drift [m] positive means will drift east</span>
<a name="l00322"></a>00322     
<a name="l00323"></a>00323     <span class="comment">//drift is in meters, constrain to not be huge</span>
<a name="l00324"></a>00324     <a class="code" href="storc_8h.html#af379d19d538c85605a7dddf0ecfd1252">drift_ns</a> = constrain(drift_ns, -500,500);
<a name="l00325"></a>00325     drift_ew = constrain(drift_ew, -500,500);
<a name="l00326"></a>00326     
<a name="l00327"></a>00327     <span class="comment">//convert drift to GPS</span>
<a name="l00328"></a>00328     <span class="keywordtype">float</span> drift_ns_gps = <a class="code" href="storc_8h.html#a6a747f54d74f99f0057be15ad44315eb" title="Macro to convert a delta of meters to a delta of GPS decimal*10^7 (latitude)">DELT_M2GPS_LAT</a>(drift_ns);
<a name="l00329"></a>00329     <span class="keywordtype">float</span> drift_ew_gps = <a class="code" href="storc_8h.html#a1b337c93876acd8326c7c3d414b7eb3f" title="Macro to convert a delta of meters to a delta of GPS decimal*10^7 (longitude)">DELT_M2GPS_LON</a>(drift_ew);
<a name="l00330"></a>00330     
<a name="l00331"></a>00331     <span class="comment">//adjust target</span>
<a name="l00332"></a>00332     <a class="code" href="controls_8h.html#acb97c108f80b20cd17488a1bd9e2f73a">LAT_C</a> = <a class="code" href="controls_8h.html#af343cb7f872e94a7f34812d01b2bf067">target_LAT</a> - drift_ns_gps*10000000;
<a name="l00333"></a>00333     <a class="code" href="controls_8h.html#a0459100820d9e59c08e793a09d5e4623">LON_C</a> = <a class="code" href="controls_8h.html#a15e9a26e90804876c1af1878f1c810aa">target_LON</a> - drift_ew_gps*10000000;
<a name="l00334"></a>00334   
<a name="l00335"></a>00335   }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   <span class="comment">//RC ----------------------------------------------------------------</span>
<a name="l00338"></a>00338   <span class="comment">//debug_rc();</span>
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   <span class="comment">//Controls ----------------------------------------------------------</span>
<a name="l00342"></a>00342   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#aae4f7019dabbfa7398307d486240d88d" title="Easy way to turn controls on (1) and off (0) - if off, Payload release is ON.">CONTROLS</a>){
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="comment">/* No Longer Doing Elevator Control</span>
<a name="l00345"></a>00345 <span class="comment">     </span>
<a name="l00346"></a>00346 <span class="comment">     if (rc_4 &gt; 1500){  // Elevator Control</span>
<a name="l00347"></a>00347 <span class="comment">     </span>
<a name="l00348"></a>00348 <span class="comment">     // If just switched on </span>
<a name="l00349"></a>00349 <span class="comment">     if(sw1 == 0){</span>
<a name="l00350"></a>00350 <span class="comment">     I_ELE = 0;                  // Reset integrator to zero </span>
<a name="l00351"></a>00351 <span class="comment">     rc_ele_trim = rc_elevator;  // Remember servo neutral position</span>
<a name="l00352"></a>00352 <span class="comment">     }</span>
<a name="l00353"></a>00353 <span class="comment">     </span>
<a name="l00354"></a>00354 <span class="comment">     sw1 = 1;                                    // Set switch variable to high</span>
<a name="l00355"></a>00355 <span class="comment">     del_ELE = 0;                                // Reset to zero</span>
<a name="l00356"></a>00356 <span class="comment">     q_c = (float)(KP_RP*(abs(phi_c)));                   // Commanded pitch rate based on rc input</span>
<a name="l00357"></a>00357 <span class="comment">     ELE_control(1.0/(float)(MED_LOOP_CLOCK));   // Run the elevator controls algorithm</span>
<a name="l00358"></a>00358 <span class="comment">     </span>
<a name="l00359"></a>00359 <span class="comment">     }</span>
<a name="l00360"></a>00360 <span class="comment">     else{</span>
<a name="l00361"></a>00361 <span class="comment">     sw1 = 0;     // Keep switch variable low</span>
<a name="l00362"></a>00362 <span class="comment">     }</span>
<a name="l00363"></a>00363 <span class="comment">     */</span>
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keywordflow">if</span> (<a class="code" href="storc_8h.html#a7fe1031f60be2285c7853174a53d86e6" title="RC switch for turning controls on/off.">rc_5</a> &gt; 1500){  <span class="comment">// Rudder Control</span>
<a name="l00366"></a>00366 
<a name="l00367"></a>00367       <span class="comment">// If just switched on </span>
<a name="l00368"></a>00368       <span class="keywordflow">if</span>(<a class="code" href="controls_8h.html#ab10d58b2cca806e246dd112dbf99f566">sw2</a> == 0){
<a name="l00369"></a>00369         <a class="code" href="controls_8h.html#a3037309a7f3bf7eb61c33793170acac9">I_RUD</a> = 0;                <span class="comment">// Reset integrator to zero</span>
<a name="l00370"></a>00370         <a class="code" href="controls_8h.html#a3d45b062c29030d035abf990432f6a4c">rc_rud_trim</a> = <a class="code" href="storc_8h.html#acfe6a51893d0a97f021b370da03312db" title="RC Rudder Input.">rc_rudder</a>;  <span class="comment">// Remember servo neutral position</span>
<a name="l00371"></a>00371       }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373       <a class="code" href="controls_8h.html#ab10d58b2cca806e246dd112dbf99f566">sw2</a> = 1;                                    <span class="comment">// Set switch variable to high</span>
<a name="l00374"></a>00374       <a class="code" href="controls_8h.html#aa0d43e445e2fce3d998bb9469ebfe2b8">del_RUD</a> = 0;                                <span class="comment">// Reset to zero</span>
<a name="l00375"></a>00375       <span class="comment">// Get phi_c from navigation (outer loop)</span>
<a name="l00376"></a>00376       <a class="code" href="controls_8h.html#a552bd6e8a5e665a817f2e604867315e3">phi_c</a> = (<a class="code" href="storc_8h.html#acfe6a51893d0a97f021b370da03312db" title="RC Rudder Input.">rc_rudder</a> - <a class="code" href="controls_8h.html#a3d45b062c29030d035abf990432f6a4c">rc_rud_trim</a>)/10.0f;    <span class="comment">// Commanded bank based on rc input (inner loop)</span>
<a name="l00377"></a>00377       <a class="code" href="controls_8pde.html#ab08ce39ee9de14bf5f269b757a8b53b5">RUD_control</a>(1.0/(<span class="keywordtype">float</span>)(<a class="code" href="storc_8h.html#ae8ba3aeaba4623869f4c0278b26e655d" title="Medium loop clock speed in Hz.">MED_LOOP_CLOCK</a>));   <span class="comment">// Run the rudder controls algorithm</span>
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380     <span class="keywordflow">else</span>{
<a name="l00381"></a>00381       <a class="code" href="controls_8h.html#ab10d58b2cca806e246dd112dbf99f566">sw2</a> = 0;    <span class="comment">// Keep switch variable low</span>
<a name="l00382"></a>00382       <a class="code" href="controls_8h.html#a552bd6e8a5e665a817f2e604867315e3">phi_c</a> = 0.0;
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385     <span class="comment">//debug_controls();</span>
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   }
<a name="l00388"></a>00388   <span class="keywordflow">else</span>{  <span class="comment">//PAYLOAD DROP ----------------------------------------------------------------</span>
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <span class="comment">//re-zero controls variables incase we are switching mid-flight</span>
<a name="l00391"></a>00391     <a class="code" href="controls_8h.html#af10a86d23fa988e8b53309318e8f1234">del_THR</a> = 0;
<a name="l00392"></a>00392     <a class="code" href="controls_8h.html#aa0d43e445e2fce3d998bb9469ebfe2b8">del_RUD</a> = 0;
<a name="l00393"></a>00393     <a class="code" href="controls_8h.html#a30a72cb2145d966472c27966568cfaef">del_ELE</a> = 0;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="comment">//alternate conditions for dropping (auto-based on GPS, or manual) based on whether GPS is active</span>
<a name="l00396"></a>00396     <span class="keywordtype">boolean</span> condition = <span class="keyword">false</span>;
<a name="l00397"></a>00397     <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a75efdde4445e3a8167a05191ccb788da" title="whether or not to use gps, based on reading the slide_switch at power-on">use_gps</a> == <span class="keyword">true</span>) { <span class="comment">//if GPS is on</span>
<a name="l00398"></a>00398       condition = <a class="code" href="storc_8h.html#ae52df017b138fde620474b3aac767231" title="RC Payload Drop Input &amp; ELE_control on/off.">rc_4</a> &gt; 1500;
<a name="l00399"></a>00399       <span class="comment">//condition = gps-&gt;latitude &gt; gps_start_lat + 0.0008*10000000; //farther than about 90 m north of start point  //bug, lose rc control</span>
<a name="l00400"></a>00400       <span class="comment">//condition = gps-&gt;latitude &lt; 399518950;</span>
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402     <span class="keywordflow">else</span> { <span class="comment">//else do manual</span>
<a name="l00403"></a>00403       condition = <a class="code" href="storc_8h.html#ae52df017b138fde620474b3aac767231" title="RC Payload Drop Input &amp; ELE_control on/off.">rc_4</a> &gt; 1500;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="comment">//drop condition</span>
<a name="l00407"></a>00407     <span class="keywordflow">if</span>( condition ) {
<a name="l00408"></a>00408       <a class="code" href="rc_8pde.html#a7249f1f0e38621ffae257b910517516e">drop_payload</a>();
<a name="l00409"></a>00409       <a class="code" href="storc_8h.html#a10b9231b0f5575e2467df3c42d117aba" title="state of the drop servo">drop_state</a> = <span class="keyword">true</span>;
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411     <span class="keywordflow">else</span> {
<a name="l00412"></a>00412       <a class="code" href="rc_8pde.html#aa5875b9da340a42d8e95b4ecf3e042cd">reset_drop</a>();
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415   }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 <span class="comment"></span>
<a name="l00419"></a>00419 <span class="comment">/**</span>
<a name="l00420"></a>00420 <span class="comment"> * Function that runs every so often, as determined by {@link FAST_LOOP_CLOCK}</span>
<a name="l00421"></a>00421 <span class="comment"> * @see loop</span>
<a name="l00422"></a>00422 <span class="comment"> */</span>
<a name="l00423"></a><a class="code" href="storc_8pde.html#a7363649c6a7e918b39a1f86a3971addb">00423</a> <span class="keywordtype">void</span> <a class="code" href="storc_8pde.html#a7363649c6a7e918b39a1f86a3971addb">fast_loop</a>(<span class="keywordtype">void</span>) {
<a name="l00424"></a>00424 
<a name="l00425"></a>00425   <span class="comment">//update DCM</span>
<a name="l00426"></a>00426   dcm.update_DCM(<a class="code" href="storc_8h.html#a86bc5084edf342b5cdaed365dbd8fb7e" title="Gyro integration time for the DCM.">GYRO_INT_TIME</a>);
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="comment">//Setup and Loop  ---------------------------------------------------</span>
<a name="l00432"></a>00432 <span class="comment"></span>
<a name="l00433"></a>00433 <span class="comment">/**</span>
<a name="l00434"></a>00434 <span class="comment"> * Arduino setup() function.  This gets called first when the board is powered</span>
<a name="l00435"></a>00435 <span class="comment"> * on.  It sets up the timers and initializes the serial connection as well as </span>
<a name="l00436"></a>00436 <span class="comment"> * any library initialization.</span>
<a name="l00437"></a>00437 <span class="comment"> */</span>
<a name="l00438"></a><a class="code" href="storc_8pde.html#a7dfd9b79bc5a37d7df40207afbc5431f">00438</a> <span class="keywordtype">void</span> <a class="code" href="storc_8pde.html#a7dfd9b79bc5a37d7df40207afbc5431f">setup</a>(<span class="keywordtype">void</span>){
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   <span class="comment">//Setup timers for fast, medium, slow loops (Arduino millis() command returns</span>
<a name="l00441"></a>00441   <span class="comment">//  current time in milliseconds in an unsigned long)</span>
<a name="l00442"></a>00442   <a class="code" href="storc_8h.html#aa5d601bc12601e33b6167036b7ad2d24">fast_timer</a> = millis();
<a name="l00443"></a>00443   <a class="code" href="storc_8h.html#acd08a5eec0425ddbef7e31333e12d15a">medium_timer</a> = millis();
<a name="l00444"></a>00444   <a class="code" href="storc_8h.html#add3765d60f7571538e6af8898c86003b">slow_timer</a> = millis();
<a name="l00445"></a>00445   <a class="code" href="storc_8h.html#abd32ead7c46076edcd6f6cb55e407d7f">telemetry_timer</a> = millis();
<a name="l00446"></a>00446 
<a name="l00447"></a>00447   <span class="comment">//Initialize LED pins, set for output</span>
<a name="l00448"></a>00448   pinMode(<a class="code" href="storc_8h.html#afc6d9edfd58550f0c5faa0bfd93c6533" title="set this pin to output to control LED A on the shield">A_LED</a>,OUTPUT);
<a name="l00449"></a>00449   pinMode(<a class="code" href="storc_8h.html#abd697fb9678d42840bd5f7f102f6429d" title="set this pin to output to control LED B on the shield">B_LED</a>,OUTPUT);
<a name="l00450"></a>00450   pinMode(<a class="code" href="storc_8h.html#a9c9b2cd83b2a76c907c6ae0ced34de6e" title="set this pin to output to control LED C on the shield">C_LED</a>,OUTPUT);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   <span class="comment">//start LEDs ON, then turn them off as initialization progresses</span>
<a name="l00453"></a>00453   digitalWrite(<a class="code" href="storc_8h.html#afc6d9edfd58550f0c5faa0bfd93c6533" title="set this pin to output to control LED A on the shield">A_LED</a>,HIGH);
<a name="l00454"></a>00454   digitalWrite(<a class="code" href="storc_8h.html#abd697fb9678d42840bd5f7f102f6429d" title="set this pin to output to control LED B on the shield">B_LED</a>,HIGH);
<a name="l00455"></a>00455   digitalWrite(<a class="code" href="storc_8h.html#a9c9b2cd83b2a76c907c6ae0ced34de6e" title="set this pin to output to control LED C on the shield">C_LED</a>,HIGH);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   <span class="comment">//Initialize Serial ---------------------------------------</span>
<a name="l00459"></a>00459   Serial.begin(115200);  <span class="comment">// Initialize Serial Communication (FTDI on Serial 0)</span>
<a name="l00460"></a>00460   <a class="code" href="storc_8h.html#a934adcefb2f626c48b3d271e957ff964" title="Initialize GPS (has to be outside of a function for some reason)">Serial1</a>.begin(38400, 128, 16);  <span class="comment">// standard gps running</span>
<a name="l00461"></a>00461   Serial3.begin(115200);  <span class="comment">// Initialize Serial3 for telemetry communication</span>
<a name="l00462"></a>00462   Serial.println(<span class="stringliteral">&quot;---------- StoRC Debug ----------&quot;</span>);
<a name="l00463"></a>00463 
<a name="l00464"></a>00464   <span class="comment">//Initialize Slide switch for input</span>
<a name="l00465"></a>00465   pinMode(<a class="code" href="storc_8h.html#a6b2520a91cab50d62e3ee45f5ae1336c" title="set this pin to input to read the state of the sliding switch on the shield">SLIDE_SWITCH</a>,INPUT);
<a name="l00466"></a>00466   <a class="code" href="storc_8h.html#aaec6ba6993984fc2ded3efe6a1e2d224" title="state of hardware switch on shield ( either LOW (0) or HIGH (1) )">slide_sw</a> = digitalRead(<a class="code" href="storc_8h.html#a6b2520a91cab50d62e3ee45f5ae1336c" title="set this pin to input to read the state of the sliding switch on the shield">SLIDE_SWITCH</a>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   <span class="comment">//slide switch determines whether to use gps or not</span>
<a name="l00469"></a>00469   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#aaec6ba6993984fc2ded3efe6a1e2d224" title="state of hardware switch on shield ( either LOW (0) or HIGH (1) )">slide_sw</a> == 1) {
<a name="l00470"></a>00470     <a class="code" href="storc_8h.html#a75efdde4445e3a8167a05191ccb788da" title="whether or not to use gps, based on reading the slide_switch at power-on">use_gps</a> = <span class="keyword">true</span>;
<a name="l00471"></a>00471   }
<a name="l00472"></a>00472   <span class="keywordflow">else</span> {
<a name="l00473"></a>00473     <a class="code" href="storc_8h.html#a75efdde4445e3a8167a05191ccb788da" title="whether or not to use gps, based on reading the slide_switch at power-on">use_gps</a> = <span class="keyword">false</span>;
<a name="l00474"></a>00474   }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476   Serial.print(<span class="stringliteral">&quot;SLIDE SWITCH: &quot;</span>);
<a name="l00477"></a>00477   Serial.println(<a class="code" href="storc_8h.html#aaec6ba6993984fc2ded3efe6a1e2d224" title="state of hardware switch on shield ( either LOW (0) or HIGH (1) )">slide_sw</a>);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479   <span class="comment">//Initialize sensors and libraries ---------------------------------------</span>
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   adc.Init(); <span class="comment">//initialize adc</span>
<a name="l00482"></a>00482 
<a name="l00483"></a>00483   <span class="comment">//Only initialize GPS if slide switch has determined we should</span>
<a name="l00484"></a>00484   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a75efdde4445e3a8167a05191ccb788da" title="whether or not to use gps, based on reading the slide_switch at power-on">use_gps</a> == <span class="keyword">true</span>) {
<a name="l00485"></a>00485     <span class="comment">//Set up GPS</span>
<a name="l00486"></a>00486     gps = &amp;gps_driver;
<a name="l00487"></a>00487     gps-&gt;init();
<a name="l00488"></a>00488     gps-&gt;update();  <span class="comment">//force the driver to detect the GPS before checking its status</span>
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <span class="comment">//Wait for full GPS lock before proceeding</span>
<a name="l00491"></a>00491     Serial.println(<span class="stringliteral">&quot;GPS Init...&quot;</span>);
<a name="l00492"></a>00492     <span class="keywordflow">while</span>(gps-&gt;status() &lt; 2) {
<a name="l00493"></a>00493       gps-&gt;update();
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     Serial.println(<span class="stringliteral">&quot; GPS Locked, waiting for altitude to settle...&quot;</span>);
<a name="l00496"></a>00496     <span class="keywordtype">long</span> count = 0;
<a name="l00497"></a>00497     <span class="keywordflow">while</span>(gps-&gt;altitude/100.0 &lt; 20 || gps-&gt;altitude/100.0 &gt; 50 ) {
<a name="l00498"></a>00498       <span class="keywordflow">if</span>(count == 100000) { <span class="comment">//(int)(gps-&gt;altitude) % 10 == 0)</span>
<a name="l00499"></a>00499         Serial.print(<span class="stringliteral">&quot;   &quot;</span>);  
<a name="l00500"></a>00500         Serial.println(gps-&gt;altitude/100.0);
<a name="l00501"></a>00501         count = 0;
<a name="l00502"></a>00502       }
<a name="l00503"></a>00503       count++;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505       gps-&gt;update();
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507     Serial.println(<span class="stringliteral">&quot; Altitude between 30 and 50 meters.&quot;</span>);
<a name="l00508"></a>00508   }
<a name="l00509"></a>00509   <span class="keywordflow">else</span> {
<a name="l00510"></a>00510     Serial.println(<span class="stringliteral">&quot;Screw GPS, man...&quot;</span>);
<a name="l00511"></a>00511   }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513   digitalWrite(<a class="code" href="storc_8h.html#afc6d9edfd58550f0c5faa0bfd93c6533" title="set this pin to output to control LED A on the shield">A_LED</a>,LOW);  <span class="comment">//done with GPS intialization</span>
<a name="l00514"></a>00514 
<a name="l00515"></a>00515   <a class="code" href="storc_8h.html#a32486781d8c078736e577cf2ab76313f" title="declare an instance of the Barometer class">barometer</a>.Init();  <span class="comment">//initialize the barometer</span>
<a name="l00516"></a>00516 
<a name="l00517"></a>00517   <a class="code" href="pitot_8pde.html#a8d2f156a671de399e700b8a22e042439">zero_pitot</a>();  <span class="comment">//initialize the airspeed measurement (must come after adc init!)</span>
<a name="l00518"></a>00518 
<a name="l00519"></a>00519   <a class="code" href="storc_8h.html#a98361fed9fa0cbb710e8ede8fb1b9298" title="declare an instance of the DCM class">imu</a>.init(IMU::COLD_START, delay); <span class="comment">//intialize IMU on ground, stationary and level</span>
<a name="l00520"></a>00520   Serial.println();
<a name="l00521"></a>00521 
<a name="l00522"></a>00522   digitalWrite(<a class="code" href="storc_8h.html#abd697fb9678d42840bd5f7f102f6429d" title="set this pin to output to control LED B on the shield">B_LED</a>,LOW);  <span class="comment">//done with IMU initialization</span>
<a name="l00523"></a>00523 
<a name="l00524"></a>00524   <span class="comment">//Initialize Magnetometer stuff</span>
<a name="l00525"></a>00525   Wire.begin();  <span class="comment">//used to communicate with the magnetometer pins</span>
<a name="l00526"></a>00526 
<a name="l00527"></a>00527   <span class="keywordtype">boolean</span> result = <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.init();
<a name="l00528"></a>00528   <span class="keywordflow">if</span>(result == <span class="keyword">true</span>) {
<a name="l00529"></a>00529     Serial.print(<span class="stringliteral">&quot;Compass found: &quot;</span>);
<a name="l00530"></a>00530   }
<a name="l00531"></a>00531   <span class="keywordflow">else</span> {
<a name="l00532"></a>00532     Serial.println(<span class="stringliteral">&quot;Compass initialization failed&quot;</span>);
<a name="l00533"></a>00533     <span class="keywordflow">while</span> (1) {
<a name="l00534"></a>00534     };
<a name="l00535"></a>00535   }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537   <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.set_orientation(AP_COMPASS_COMPONENTS_DOWN_PINS_FORWARD);  <span class="comment">// set compass&#39;s orientation on aircraft.</span>
<a name="l00538"></a>00538   <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.set_offsets(0,0,0);  <span class="comment">// set offsets to account for surrounding interference</span>
<a name="l00539"></a>00539   <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.set_declination(0.213221057);  <span class="comment">// set local difference between magnetic north and true north (Philadelphia: 12 deg, 13 min)</span>
<a name="l00540"></a>00540 
<a name="l00541"></a>00541   <span class="keywordflow">switch</span>( <a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.product_id ) {
<a name="l00542"></a>00542   <span class="keywordflow">case</span> AP_COMPASS_TYPE_HIL:
<a name="l00543"></a>00543     Serial.println(<span class="stringliteral">&quot;HIL&quot;</span>);
<a name="l00544"></a>00544     <span class="keywordflow">break</span>;
<a name="l00545"></a>00545   <span class="keywordflow">case</span> AP_COMPASS_TYPE_HMC5843:
<a name="l00546"></a>00546     Serial.println(<span class="stringliteral">&quot;HMC5843&quot;</span>);
<a name="l00547"></a>00547     <span class="keywordflow">break</span>;
<a name="l00548"></a>00548   <span class="keywordflow">case</span> AP_COMPASS_TYPE_HMC5883L:
<a name="l00549"></a>00549     Serial.println(<span class="stringliteral">&quot;HMC5883L&quot;</span>);
<a name="l00550"></a>00550     <span class="keywordflow">break</span>;
<a name="l00551"></a>00551   <span class="keywordflow">default</span>:
<a name="l00552"></a>00552     Serial.println(<span class="stringliteral">&quot;unknown&quot;</span>);
<a name="l00553"></a>00553     <span class="keywordflow">break</span>;
<a name="l00554"></a>00554   }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="comment">//DCM</span>
<a name="l00557"></a>00557   dcm.set_compass(&amp;<a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>);
<a name="l00558"></a>00558   dcm.set_centripetal(1);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560   <span class="comment">//initialize the flash memory</span>
<a name="l00561"></a>00561   DataFlash.Init();
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a159ca84d25a5487d8e81e4438725df19" title="Easy way to turn logging on (1) and off (0)">LOG</a>) {
<a name="l00564"></a>00564     <a class="code" href="log_8pde.html#a1d92e4e401e8210f92ee4b44cdf56ba9">start_new_log</a>(<a class="code" href="log_8pde.html#a5104c96db495828f3312e206a7f2329e">get_num_logs</a>());  <span class="comment">//start a fresh log if logging is turned on</span>
<a name="l00565"></a>00565   }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567   APM_RC.Init();  <span class="comment">// Initialize RC library</span>
<a name="l00568"></a>00568 
<a name="l00569"></a>00569   <span class="comment">//initialize code parameters -----------------------------------</span>
<a name="l00570"></a>00570 
<a name="l00571"></a>00571   <span class="comment">//Initialize the drop timer</span>
<a name="l00572"></a>00572   <span class="comment">//drop_timer = -1;  </span>
<a name="l00573"></a>00573   <a class="code" href="rc_8pde.html#aa5875b9da340a42d8e95b4ecf3e042cd">reset_drop</a>();
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 
<a name="l00576"></a>00576   <span class="comment">//Initialize accel and gyro readings</span>
<a name="l00577"></a>00577   <a class="code" href="storc_8h.html#a98361fed9fa0cbb710e8ede8fb1b9298" title="declare an instance of the DCM class">imu</a>.update();
<a name="l00578"></a>00578   <a class="code" href="storc_8h.html#aac5141d38d1cbc17d4dd0610a1426354">accel</a> = <a class="code" href="storc_8h.html#a98361fed9fa0cbb710e8ede8fb1b9298" title="declare an instance of the DCM class">imu</a>.get_accel();
<a name="l00579"></a>00579   <a class="code" href="storc_8h.html#a0d1811f25a78ba85a95c6514830b1fff">gyro</a> = <a class="code" href="storc_8h.html#a98361fed9fa0cbb710e8ede8fb1b9298" title="declare an instance of the DCM class">imu</a>.get_gyro();
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   <span class="comment">//save starting GPS location</span>
<a name="l00582"></a>00582   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a75efdde4445e3a8167a05191ccb788da" title="whether or not to use gps, based on reading the slide_switch at power-on">use_gps</a> == <span class="keyword">true</span>) {
<a name="l00583"></a>00583     gps-&gt;update();
<a name="l00584"></a>00584     <a class="code" href="storc_8h.html#a5aa0a8aaed7d1464ffc8174e99c4b151">gps_start_lat</a> = gps-&gt;latitude;
<a name="l00585"></a>00585     <a class="code" href="storc_8h.html#a0c76265d161a9b98826fda3e18f51ee3">gps_start_lon</a> = gps-&gt;longitude;
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588   digitalWrite(<a class="code" href="storc_8h.html#a9c9b2cd83b2a76c907c6ae0ced34de6e" title="set this pin to output to control LED C on the shield">C_LED</a>,LOW);  <span class="comment">//done with initialization</span>
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 <span class="comment"></span>
<a name="l00591"></a>00591 <span class="comment">/**</span>
<a name="l00592"></a>00592 <span class="comment"> * Arduino loop() function.  This is called immediately after {@link setup} and</span>
<a name="l00593"></a>00593 <span class="comment"> * it loops as long as the board is powered.  This function calls everything else</span>
<a name="l00594"></a>00594 <span class="comment"> * that runs.  Using timers and periods set by {@link SLOW_LOOP_CLOCK}, </span>
<a name="l00595"></a>00595 <span class="comment"> * {@link MED_LOOP_CLOCK}, and {@link FAST_LOOP_CLOCK}, it determines when to call</span>
<a name="l00596"></a>00596 <span class="comment"> * each subfunction and also calls what needs to run at full speed.</span>
<a name="l00597"></a>00597 <span class="comment"> */</span>
<a name="l00598"></a><a class="code" href="storc_8pde.html#a0b33edabd7f1c4e4a0bf32c67269be2f">00598</a> <span class="keywordtype">void</span> <a class="code" href="storc_8pde.html#a0b33edabd7f1c4e4a0bf32c67269be2f">loop</a>(<span class="keywordtype">void</span>){
<a name="l00599"></a>00599 
<a name="l00600"></a>00600   <span class="comment">//Full speed loop (things that are done every iteration of loop() )</span>
<a name="l00601"></a>00601 
<a name="l00602"></a>00602   <a class="code" href="rc_8pde.html#a03cb37f8a2fec5044afa0d2d5fa95970">read_RC</a>();  <span class="comment">//Get RC commands from controller</span>
<a name="l00603"></a>00603 
<a name="l00604"></a>00604   <span class="comment">// Slow Loop check</span>
<a name="l00605"></a>00605   <span class="keywordflow">if</span>( millis() - <a class="code" href="storc_8h.html#add3765d60f7571538e6af8898c86003b">slow_timer</a> &gt;= 1000/<a class="code" href="storc_8h.html#a9683a7d8139095901da8a77ad48938bf" title="Slow loop clock speed in Hz.">SLOW_LOOP_CLOCK</a> ) {
<a name="l00606"></a>00606     <a class="code" href="storc_8h.html#add3765d60f7571538e6af8898c86003b">slow_timer</a> = millis();
<a name="l00607"></a>00607     <a class="code" href="storc_8pde.html#a4204d4ae4375267ad4d5f5218e2b082e">slow_loop</a>();
<a name="l00608"></a>00608   }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610   <span class="comment">// Medium Loop check</span>
<a name="l00611"></a>00611   <span class="keywordflow">if</span>( millis() - <a class="code" href="storc_8h.html#acd08a5eec0425ddbef7e31333e12d15a">medium_timer</a> &gt;= 1000/<a class="code" href="storc_8h.html#ae8ba3aeaba4623869f4c0278b26e655d" title="Medium loop clock speed in Hz.">MED_LOOP_CLOCK</a> ) {
<a name="l00612"></a>00612     <a class="code" href="storc_8h.html#acd08a5eec0425ddbef7e31333e12d15a">medium_timer</a> = millis();
<a name="l00613"></a>00613     <a class="code" href="storc_8pde.html#a42b0ee59afb14d568f6ae6aae8121331">medium_loop</a>();
<a name="l00614"></a>00614   }
<a name="l00615"></a>00615 
<a name="l00616"></a>00616   <span class="comment">// Fast Loop check</span>
<a name="l00617"></a>00617   <span class="keywordflow">if</span>( millis() - <a class="code" href="storc_8h.html#aa5d601bc12601e33b6167036b7ad2d24">fast_timer</a> &gt;= 1000/<a class="code" href="storc_8h.html#abf4cfcf2a33fbe31b052c9ef8449150a" title="Fast loop clock speed in Hz.">FAST_LOOP_CLOCK</a> ) {
<a name="l00618"></a>00618     <a class="code" href="storc_8h.html#aa5d601bc12601e33b6167036b7ad2d24">fast_timer</a> = millis();
<a name="l00619"></a>00619     <a class="code" href="storc_8pde.html#a7363649c6a7e918b39a1f86a3971addb">fast_loop</a>();
<a name="l00620"></a>00620   }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622   <span class="comment">//telemetry</span>
<a name="l00623"></a>00623   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#ac7265d02c447848ab4293684f5e94431" title="Easy way to turn telemetry on (1) and off (0)">TELEMETRY</a>) {
<a name="l00624"></a>00624     <span class="keywordflow">if</span>( millis() - <a class="code" href="storc_8h.html#abd32ead7c46076edcd6f6cb55e407d7f">telemetry_timer</a> &gt;= 1000/<a class="code" href="storc_8h.html#addeedd5dea91765aae8498a258b1311c" title="Telemetry transmit speed in Hz.">TELEMETRY_CLOCK</a> ) {
<a name="l00625"></a>00625       <a class="code" href="storc_8h.html#abd32ead7c46076edcd6f6cb55e407d7f">telemetry_timer</a> = millis();
<a name="l00626"></a>00626       <a class="code" href="telemetry_8pde.html#a9926a12daaecdbb4d8106ed110510d49">transmit_data</a>();
<a name="l00627"></a>00627     }
<a name="l00628"></a>00628   }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630   <span class="comment">//important, higher-speed logging</span>
<a name="l00631"></a>00631   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#a159ca84d25a5487d8e81e4438725df19" title="Easy way to turn logging on (1) and off (0)">LOG</a>) {
<a name="l00632"></a>00632     <span class="keywordflow">if</span>( millis() - <a class="code" href="storc_8h.html#ae3eded80e884912f722c0d8cf0d2c666">logging_timer</a> &gt;= 1000/<a class="code" href="storc_8h.html#a7600f3f33b2d3b2f911f261767e17a15" title="Logging speed in Hz (except for GPS and barometer, which are in the slow loop)">LOGGING_CLOCK</a> ) {
<a name="l00633"></a>00633       <a class="code" href="storc_8h.html#ae3eded80e884912f722c0d8cf0d2c666">logging_timer</a> = millis();
<a name="l00634"></a>00634 
<a name="l00635"></a>00635       <span class="keywordflow">if</span> (<a class="code" href="storc_8h.html#a93b44c9ef85d047faf95d68a82611677" title="state of the logging switch on analog 6 (see LOGGING_SWITCH)">logging_sw</a> &gt; 512) {        
<a name="l00636"></a>00636         <a class="code" href="log_8pde.html#a7e3e2cfbd827d2867f7b8f35dd8f7a76">Log_Write_IMU</a>(<a class="code" href="storc_8h.html#a0d1811f25a78ba85a95c6514830b1fff">gyro</a>.x, <a class="code" href="storc_8h.html#a0d1811f25a78ba85a95c6514830b1fff">gyro</a>.y, <a class="code" href="storc_8h.html#a0d1811f25a78ba85a95c6514830b1fff">gyro</a>.z, <a class="code" href="storc_8h.html#aac5141d38d1cbc17d4dd0610a1426354">accel</a>.x, <a class="code" href="storc_8h.html#aac5141d38d1cbc17d4dd0610a1426354">accel</a>.y, <a class="code" href="storc_8h.html#aac5141d38d1cbc17d4dd0610a1426354">accel</a>.z);
<a name="l00637"></a>00637         <a class="code" href="log_8pde.html#a9c43819334e2ef704c40fc75dbf477e4">Log_Write_Magnetometer</a>(<a class="code" href="storc_8h.html#af93ab8e29004f71549e1cd50278c5473" title="Macro to convert radians to degrees.">RAD2DEG</a>(<a class="code" href="storc_8h.html#a673237fd4f6a1ad73578962737111b7d" title="declare an instance of the Magnetometer class">compass</a>.heading), dcm.roll_sensor/100.0, dcm.pitch_sensor/100.0, dcm.yaw_sensor/100.0);
<a name="l00638"></a>00638         <a class="code" href="log_8pde.html#a2479d1c46862a6e13c7e43d605f30883">Log_Write_Airspeed</a>(<a class="code" href="storc_8h.html#a2a48553c0ca332797b83fc7147f15679" title="stores current airspeed reading">airspeed</a>);
<a name="l00639"></a>00639         <a class="code" href="log_8pde.html#a10480e44ab9eaa3009a2885c2adab228">Log_Write_RC</a>(<a class="code" href="storc_8h.html#ac7aad18463e0da2e080b3bf11cf6b1dc" title="RC Elevator Input.">rc_elevator</a>,<a class="code" href="storc_8h.html#acfe6a51893d0a97f021b370da03312db" title="RC Rudder Input.">rc_rudder</a>,<a class="code" href="storc_8h.html#a3d6851b64714dca0406b6acb9a9e0867" title="RC Throttle Input.">rc_throttle</a>, <a class="code" href="storc_8h.html#ae52df017b138fde620474b3aac767231" title="RC Payload Drop Input &amp; ELE_control on/off.">rc_4</a>, <a class="code" href="storc_8h.html#a7fe1031f60be2285c7853174a53d86e6" title="RC switch for turning controls on/off.">rc_5</a>, <a class="code" href="storc_8h.html#af62bacc6572a709d8b53dbaa848350bd" title="RC knob for adjusting controls gain.">rc_6</a>, <a class="code" href="storc_8h.html#a70b30eaa53011cda6e531979b2c7ff19" title="RC knob for adjusting controls gain.">rc_7</a>, <a class="code" href="storc_8h.html#a094619a37f45fe299b023725e64edae1">rc_8</a>);
<a name="l00640"></a>00640         <a class="code" href="log_8pde.html#a8122e99ee0a1358f3287d8f1c291f715">Log_Write_Controls_Rudder</a>(<a class="code" href="controls_8h.html#af5c1abfd070ffdb96c1179004ebd2c95">KP_RUD</a>, <a class="code" href="controls_8h.html#a4e37a65cd420f4701ff8b43e8cb9d847">kp_rud_gm</a>, <a class="code" href="controls_8h.html#a95022c4902729d8239e4b2e952139151">KD_RUD</a>, <a class="code" href="controls_8h.html#acceb0234243004fb7187b9193eb99481">kd_rud_gm</a>, <a class="code" href="controls_8h.html#a4988dc34e5243e7a5e8f9290e5e7b3b0">KI_RUD</a>, <a class="code" href="controls_8h.html#a6aae62979d8cce47039ce5598d23e524">ki_rud_gm</a>, <a class="code" href="controls_8h.html#a3037309a7f3bf7eb61c33793170acac9">I_RUD</a>, <a class="code" href="controls_8h.html#aa0d43e445e2fce3d998bb9469ebfe2b8">del_RUD</a>);
<a name="l00641"></a>00641         <span class="comment">//Log_Write_Controls_Elevator(KP_ELE, kp_ele_gm, KP_RP, KI_ELE, ki_ele_gm, I_ELE, del_ELE);</span>
<a name="l00642"></a>00642         <a class="code" href="log_8pde.html#a3df5e7790ddb23a99756039378b72370">Log_Write_Controls_Throttle</a>(<a class="code" href="controls_8h.html#a28e476473598c00e13d2ee1fa29e4d46">KP_THR</a>, <a class="code" href="controls_8h.html#afba09486ff1841c90cfff4e2c79c751f">kp_thr_gm</a>, <a class="code" href="controls_8h.html#a50d387d006bcf53b4fa876d572dbd6a0">KI_THR</a>, <a class="code" href="controls_8h.html#adb1a2bf846054ee33447c23a55f12ef4">ki_thr_gm</a>, <a class="code" href="controls_8h.html#a49d01e7954a41df3957c93453088a421">I_THR</a>, <a class="code" href="controls_8h.html#ad6f7b698df81379f322aa7e05dbfdf4c">del_ALT</a>, <a class="code" href="controls_8h.html#af10a86d23fa988e8b53309318e8f1234">del_THR</a>);
<a name="l00643"></a>00643       }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648   <span class="comment">//decide whether to add controls</span>
<a name="l00649"></a>00649   <span class="keywordflow">if</span>(<a class="code" href="storc_8h.html#aae4f7019dabbfa7398307d486240d88d" title="Easy way to turn controls on (1) and off (0) - if off, Payload release is ON.">CONTROLS</a>){
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     <span class="keywordflow">if</span> (<a class="code" href="storc_8h.html#a7fe1031f60be2285c7853174a53d86e6" title="RC switch for turning controls on/off.">rc_5</a> &gt; 1500){  <span class="comment">// Rudder Control</span>
<a name="l00652"></a>00652       <a class="code" href="storc_8h.html#acfe6a51893d0a97f021b370da03312db" title="RC Rudder Input.">rc_rudder</a> = <a class="code" href="controls_8h.html#a3d45b062c29030d035abf990432f6a4c">rc_rud_trim</a> + <a class="code" href="controls_8h.html#aa0d43e445e2fce3d998bb9469ebfe2b8">del_RUD</a>;
<a name="l00653"></a>00653     }
<a name="l00654"></a>00654     <span class="keywordflow">if</span> (<a class="code" href="storc_8h.html#ae52df017b138fde620474b3aac767231" title="RC Payload Drop Input &amp; ELE_control on/off.">rc_4</a> &gt; 1500) {  <span class="comment">// Throttle Control</span>
<a name="l00655"></a>00655       <a class="code" href="storc_8h.html#a3d6851b64714dca0406b6acb9a9e0867" title="RC Throttle Input.">rc_throttle</a> = <a class="code" href="controls_8h.html#a265d52eb5fb1816176e4d3124e1b01b7">rc_thr_trim</a> + <a class="code" href="controls_8h.html#af10a86d23fa988e8b53309318e8f1234">del_THR</a>;
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658   }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660   <span class="comment">//debug_controls();</span>
<a name="l00661"></a>00661   <a class="code" href="rc_8pde.html#aac7417a5a15bd3c2014c0063ce627a87">send_RC</a>();  <span class="comment">//Send RC commands to outputs</span>
<a name="l00662"></a>00662 
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 
<a name="l00691"></a>00691 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="storc_8pde.html">storc.pde</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Thu Apr 26 2012 16:03:43 for StoRC by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
